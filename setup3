#!/bin/bash
echo "üîó Etapa 3: Instalando Node-RED + Mosquitto..."

# Node-RED e PM2
sudo npm install -g --unsafe-perm node-red
sudo npm install -g pm2
pm2 start `which node-red` -- -v
pm2 save
pm2 startup | tail -2 | head -1 | sed 's/^/sudo /' | bash

# Autentica√ß√£o Node-RED
NR_CONFIG=~/.node-red/settings.js
if grep -q "adminAuth" "$NR_CONFIG"; then
  echo "üîê Autentica√ß√£o j√° configurada no Node-RED."
else
  echo "üîê Configurando autentica√ß√£o no Node-RED..."
  PASSWORD_HASH=$(node -e "console.log(require('bcryptjs').hashSync('admin123', 8))")
  sed -i "/^module.exports = {/a\ \ \ \ adminAuth: {\n\
    \ \ \ \ \ \ type: \"credentials\",\n\
    \ \ \ \ \ \ users: [{\n\
    \ \ \ \ \ \ \ \ username: \"admin\",\n\
    \ \ \ \ \ \ \ \ password: \"$PASSWORD_HASH\",\n\
    \ \ \ \ \ \ \ \ permissions: \"*\"\n\
    \ \ \ \ \ \ }]\n\
  \ \ \ \ }," $NR_CONFIG
fi

# Mosquitto MQTT
sudo apt install -y mosquitto mosquitto-clients
sudo systemctl enable mosquitto
sudo systemctl start mosquitto
