#!/bin/bash
echo "⏳ Iniciando instalação do ambiente de energia..."

# Atualizar sistema
sudo apt update && sudo apt upgrade -y

# Pacotes básicos
sudo apt install -y curl wget gnupg2 software-properties-common net-tools git unzip openssh-server

# Node.js (versão 18) + npm
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs build-essential

# Node-RED
sudo npm install -g --unsafe-perm node-red
sudo npm install -g pm2
pm2 start `which node-red` -- -v
pm2 save
pm2 startup

# InfluxDB
curl -sL https://repos.influxdata.com/influxdb.key | sudo apt-key add -
echo "deb https://repos.influxdata.com/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/influxdb.list
sudo apt update
sudo apt install -y influxdb
sudo systemctl enable influxdb
sudo systemctl start influxdb

# Grafana
sudo mkdir -p /etc/apt/keyrings
wget -q -O - https://packages.grafana.com/gpg.key | sudo gpg --dearmor -o /etc/apt/keyrings/grafana.gpg
echo "deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://packages.grafana.com/oss/deb stable main" | sudo tee /etc/apt/sources.list.d/grafana.list
sudo apt update
sudo apt install -y grafana
sudo systemctl enable grafana-server
sudo systemctl start grafana-server

# Mensagem final
echo ""
echo "✅ Instalação concluída com sucesso!"
echo "➡️ Acesse Node-RED:  http://<seu_ip_local>:1880"
echo "➡️ Acesse Grafana:   http://<seu_ip_local>:3000 (admin/admin)"
echo "➡️ InfluxDB ativo em: http://<seu_ip_local>:8086"
