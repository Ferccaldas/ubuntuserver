#!/bin/bash

# ============================================
echo "üîß Iniciando checkup completo do servidor..."
echo "============================================"
read -p "Pressione ENTER para iniciar..."

# 1. STATUS DE SERVI√áOS ESSENCIAIS
echo -e "\nüìå STATUS DOS SERVI√áOS ESSENCIAIS:"
for service in influxdb grafana-server mosquitto; do
  systemctl is-active --quiet $service && 
    echo "‚úÖ $service est√° ativo." || 
    echo "‚ùå $service n√£o est√° ativo."
done
read -p "Pressione ENTER para continuar..."

# 2. STATUS DO NODE-RED
echo -e "\nüìå STATUS DO NODE-RED via PM2:"
pm2 list | grep -q "node-red" && echo "‚úÖ Node-RED est√° rodando via PM2." || echo "‚ùå Node-RED n√£o est√° rodando."
read -p "Pressione ENTER para continuar..."

# 3. STATUS NO BOOT
echo -e "\nüìå SERVI√áOS HABILITADOS NO BOOT:"
for service in influxdb grafana-server mosquitto; do
  systemctl is-enabled --quiet $service && 
    echo "‚úÖ $service est√° habilitado no boot." || 
    echo "‚ùå $service n√£o est√° habilitado no boot."
done
read -p "Pressione ENTER para continuar..."

# 4. LOGS DO NODE-RED
echo -e "\nüìÑ √öltimas 10 linhas do log de sa√≠da do Node-RED:"
tail -n 10 ~/.pm2/logs/node-red-out.log

echo -e "\n‚ö†Ô∏è √öltimas 10 linhas do log de erro do Node-RED:"
tail -n 10 ~/.pm2/logs/node-red-error.log
read -p "Pressione ENTER para continuar..."

# 5. BANCOS INFLUXDB
echo -e "\nüìå BANCOS DE DADOS InfluxDB:"
if command -v influx > /dev/null; then
  influx -execute 'SHOW DATABASES'
else
  echo "‚ùå Cliente influxdb-client n√£o instalado."
fi
read -p "Pressione ENTER para continuar..."

# 6. BACKUP CRON
echo -e "\nüìå BACKUP no CRON:"
sudo crontab -l | grep backup_influxdb.sh && echo "‚úÖ Cron ativo para backup InfluxDB." || echo "‚ùå Cron de backup n√£o encontrado."
read -p "Pressione ENTER para continuar..."

# 7. SCRIPT DE BACKUP
echo -e "\nüìå Script de backup:"
[ -f /usr/local/bin/backup_influxdb.sh ] && echo "‚úÖ Script de backup existe." || echo "‚ùå Script de backup n√£o localizado."
read -p "Pressione ENTER para continuar..."

# 8. FIREWALL UFW
echo -e "\nüìå FIREWALL UFW:"
sudo ufw status verbose
read -p "Pressione ENTER para continuar..."

# 9. AUTENTICA√á√ÉO NODE-RED
echo -e "\nüìå Autentica√ß√£o no Node-RED:"
grep -q "adminAuth" ~/.node-red/settings.js && echo "‚úÖ Autentica√ß√£o ativada." || echo "‚ö†Ô∏è Autentica√ß√£o n√£o configurada."
read -p "Pressione ENTER para continuar..."

# 10. USO DE RECURSOS
echo -e "\nüìä USO DE RECURSOS DO SISTEMA:"
free -h
df -h | grep -E "^Filesystem|/dev"
top -b -n1 | head -15
read -p "Pressione ENTER para continuar..."

# 11. CONECTIVIDADE DE REDE
echo -e "\nüåê TESTE DE CONECTIVIDADE:"
ping -c 2 8.8.8.8 && echo "‚úÖ Internet acess√≠vel." || echo "‚ùå Sem conex√£o com a internet."
nslookup google.com >/dev/null && echo "‚úÖ DNS funcionando." || echo "‚ùå Problema de DNS."
read -p "Pressione ENTER para continuar..."

# 12. ATUALIZA√á√ïES
echo -e "\nüîÑ VERIFICA√á√ÉO DE ATUALIZA√á√ïES:"
sudo apt update > /dev/null
apt list --upgradable
[ -f /var/run/reboot-required ] && echo "‚ö†Ô∏è Reboot necess√°rio." || echo "‚úÖ Nenhum reboot pendente."
read -p "Pressione ENTER para continuar..."

# 13. LOGS DE ERROS
echo -e "\nüõ†Ô∏è ERROS RECENTES NO SISTEMA:"
journalctl -p 3 -xb | tail -20
read -p "Pressione ENTER para finalizar..."

echo -e "\n‚úÖ Checkup completo finalizado com sucesso!"
echo "============================================="
