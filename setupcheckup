#!/bin/bash

echo "ğŸ” Iniciando verificaÃ§Ã£o do servidor de gestÃ£o de energia..."
echo "============================================================"

# 1. Verificar status dos serviÃ§os
echo -e "\nğŸ“Œ STATUS DOS SERVIÃ‡OS:"
for service in influxdb grafana-server mosquitto; do
  systemctl is-active --quiet $service && \
    echo "âœ… $service estÃ¡ ativo." || \
    echo "âŒ $service nÃ£o estÃ¡ ativo."
done

echo -e "\nğŸ“Œ STATUS DO Node-RED via PM2:"
pm2 list | grep -q "node-red" && echo "âœ… Node-RED rodando pelo PM2" || echo "âŒ Node-RED nÃ£o estÃ¡ rodando"

# 2. Verificar se estÃ£o habilitados no boot
echo -e "\nğŸ“Œ SERVIÃ‡OS HABILITADOS NO BOOT:"
for service in influxdb grafana-server mosquitto; do
  systemctl is-enabled --quiet $service && \
    echo "âœ… $service estÃ¡ habilitado no boot." || \
    echo "âŒ $service nÃ£o estÃ¡ habilitado no boot."
done

# 3. Verificar banco de dados InfluxDB
echo -e "\nğŸ“Œ BANCOS DE DADOS InfluxDB:"
if command -v influx > /dev/null; then
  influx -execute 'SHOW DATABASES'
else
  echo "âŒ Cliente influxdb-client nÃ£o instalado."
fi

# 4. Verificar cron do backup
echo -e "\nğŸ“Œ BACKUP agendado no CRON:"
sudo crontab -l | grep backup_influxdb.sh && echo "âœ… Cron ativo para backup InfluxDB." || echo "âŒ Cron de backup nÃ£o encontrado."

# 5. Verificar se o script de backup existe
echo -e "\nğŸ“Œ Script de backup:"
[ -f /usr/local/bin/backup_influxdb.sh ] && echo "âœ… Script de backup existe." || echo "âŒ Script de backup nÃ£o localizado."

# 6. Verificar regras do firewall
echo -e "\nğŸ“Œ FIREWALL UFW:"
sudo ufw status verbose

# 7. Verificar autenticaÃ§Ã£o do Node-RED
echo -e "\nğŸ“Œ AutenticaÃ§Ã£o Node-RED:"
grep -q "adminAuth" ~/.node-red/settings.js && echo "âœ… AutenticaÃ§Ã£o estÃ¡ ativada no Node-RED." || echo "âŒ AutenticaÃ§Ã£o nÃ£o encontrada no settings.js."

echo -e "\nâœ… VerificaÃ§Ã£o concluÃ­da."
echo "============================================================"
