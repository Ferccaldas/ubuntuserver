#!/bin/bash

echo "ğŸ”§ Verificando o funcionamento do Node-RED..."
echo "==============================================="

read -p "Pressione ENTER para iniciar a verificaÃ§Ã£o..."

# 1. Verifica se Node-RED estÃ¡ instalado
echo -e "\nğŸ“¦ Verificando instalaÃ§Ã£o do Node-RED..."
if ! command -v node-red &> /dev/null; then
  echo "âŒ Node-RED nÃ£o estÃ¡ instalado. Instalando agora..."
  sudo npm install -g --unsafe-perm node-red
else
  echo "âœ… Node-RED estÃ¡ instalado."
fi
read -p "Pressione ENTER para continuar..."

# 2. Verifica se PM2 estÃ¡ instalado
echo -e "\nğŸ“¦ Verificando instalaÃ§Ã£o do PM2..."
if ! command -v pm2 &> /dev/null; then
  echo "âŒ PM2 nÃ£o estÃ¡ instalado. Instalando agora..."
  sudo npm install -g pm2
else
  echo "âœ… PM2 estÃ¡ instalado."
fi
read -p "Pressione ENTER para continuar..."

# 3. Verifica se Node-RED estÃ¡ rodando com PM2
echo -e "\nğŸš€ Verificando se Node-RED estÃ¡ rodando via PM2..."
pm2 list | grep -q "node-red"
if [ $? -eq 0 ]; then
  echo "âœ… Node-RED estÃ¡ rodando via PM2."
else
  echo "âš ï¸ Node-RED nÃ£o estÃ¡ rodando. Tentando iniciar..."
  pm2 start $(which node-red) --name node-red
  pm2 save
fi
read -p "Pressione ENTER para continuar..."

# 4. Verifica logs de erro recentes do Node-RED
echo -e "\nğŸ“‹ Exibindo Ãºltimos logs do Node-RED:"
pm2 logs node-red --lines 10 --nostream
read -p "Pressione ENTER para continuar..."

# 5. Testa se o processo responde na porta padrÃ£o (1880)
echo -e "\nğŸŒ Testando acesso Ã  porta 1880 (Node-RED)..."
sudo ss -tuln | grep ':1880' && \
  echo "âœ… Porta 1880 estÃ¡ ativa." || \
  echo "âŒ Porta 1880 nÃ£o estÃ¡ ativa."
read -p "Pressione ENTER para continuar..."

# 6. Verifica autenticaÃ§Ã£o (adminAuth) no settings.js
echo -e "\nğŸ” Verificando autenticaÃ§Ã£o do Node-RED:"
grep -q "adminAuth" ~/.node-red/settings.js && \
  echo "âœ… AutenticaÃ§Ã£o estÃ¡ ativada no settings.js." || \
  echo "âš ï¸ AutenticaÃ§Ã£o nÃ£o encontrada. Recomenda-se configurar."
read -p "Pressione ENTER para continuar..."

# 7. Reinicia Node-RED com PM2
echo -e "\nâ™»ï¸ Reiniciando Node-RED com PM2..."
pm2 restart node-red
read -p "Pressione ENTER para continuar..."

# 8. Confirma status final
echo -e "\nğŸ“ˆ Status final do processo Node-RED:"
pm2 status node-red

echo -e "\nâœ… VerificaÃ§Ã£o finalizada com sucesso."
echo "==============================================="
